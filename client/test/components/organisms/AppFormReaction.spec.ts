import { fireEvent, render, waitFor, within } from '@testing-library/vue'
import { mocked } from 'ts-jest/utils'
import { ref } from '@vue/composition-api'
import dayjs from 'dayjs'

import AppFormReaction from '~/components/organisms/AppFormReaction.vue'
import * as store from '~/store'
import useReactionsApi from '~/composables/use-reactions-api'
import settingFactory from '~/test/factories/setting'
import postFactory from '~/test/factories/post'
import Reaction from '~/models/Reaction'
import Pagination from '~/models/Pagination'
import reactionFactory from '~/test/factories/reaction'
import paginationFactory from '~/test/factories/pagination'
import useMockedComponent from '~/test/stubs/MockedComponent'
import userFactory from '~/test/factories/user'
import Post from '~/models/Post'

jest.mock('~/composables/use-reactions-api')

describe('components/organisms/AppFormReaction', () => {
  let options: any
  let reactionsApiMock: any

  beforeEach(() => {
    options = {
      props: {
        post: postFactory.build()
      },
      stubs: {
        FontAwesomeIcon: true,
        TwemojiPicker: true
      }
    }

    jest.spyOn(store, 'useStore').mockReturnValue(store.store)
    store.store.setting.setData(settingFactory.build())

    reactionsApiMock = {
      reaction: ref<Reaction|null>(null),
      reactions: ref<Reaction[]>([]),
      pagination: ref<Pagination|null>(null),
      index: jest.fn().mockResolvedValue(null),
      indexing: ref(false),
      create: jest.fn().mockResolvedValue(null),
      creating: ref(false),
      destroy: jest.fn().mockResolvedValue(null),
      destroying: ref(false)
    }
    mocked(useReactionsApi).mockReturnValue({ ...reactionsApiMock })
  })

  test('renders correctly', () => {
    store.store.setting.setData(settingFactory.build({
      postDefault: {
        denyRobotScope: [],
        enableReaction: true,
        enableTwitterShare: true,
        allowedEmojis: [],
        deniedEmojis: []
      }
    }))
    const { container } = render(AppFormReaction, options)

    expect(container).toMatchSnapshot()
  })

  describe('props', () => {
    describe('post', () => {
      test('reactions„ÅÆÁµµÊñáÂ≠ó„ÇíÈÄÜÈ†Ü„ÅßË°®Á§∫', () => {
        options.props.post = postFactory.build({
          reactions: [
            reactionFactory.build({ emoji: 'üç£' }),
            reactionFactory.build({ emoji: 'üíØ' })
          ]
        })
        const { getAllByAltText } = render(AppFormReaction, options)

        expect(getAllByAltText(/üç£|üíØ/)).toHaveLength(2)
        expect(getAllByAltText(/üç£|üíØ/)[0]).toHaveAttribute('alt', 'üíØ')
        expect(getAllByAltText(/üç£|üíØ/)[1]).toHaveAttribute('alt', 'üç£')
      })

      test('AppTwemojiPicker„Å´emojis„ÇíÊ∏°„Åô', () => {
        const { component, propsList } = useMockedComponent({ props: ['emojis'] })
        options.stubs.AppTwemojiPicker = component
        options.props.post = postFactory.build({ emojis: ['üç£'] })
        render(AppFormReaction, options)

        expect(propsList[0].emojis).toStrictEqual(['üç£'])
      })
    })
  })

  describe('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫', () => {
    beforeEach(() => {
      options.props.post = postFactory.build({
        reactions: reactionFactory.buildList(100, { emoji: 'üíØ' }),
        reactionsCount: 101
      })
    })

    test('„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Åå100‰ª∂‰ª•‰∏ä„ÅÇ„ÇãÊôÇ„Å´Ë°®Á§∫', async () => {
      const { queryByTitle, updateProps } = render(AppFormReaction, options)

      expect(queryByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).toBeInTheDocument()

      await updateProps({
        post: postFactory.build({
          reactions: reactionFactory.buildList(100),
          reactionsCount: 100
        })
      })
      expect(queryByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).not.toBeInTheDocument()
    })

    test('pagination.lastPage„Åå1„ÅÆÂ†¥Âêà„ÅØË°®Á§∫„Åó„Å™„ÅÑ', () => {
      reactionsApiMock.pagination.value = paginationFactory.build({ lastPage: 1 })
      const { queryByTitle } = render(AppFormReaction, options)

      expect(queryByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).not.toBeInTheDocument()
    })

    test('„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®index„ÇíÂÆüË°å', async () => {
      const lastReaction = options.props.post.reactions.slice(-1).pop()
      const { getByTitle } = render(AppFormReaction, options)

      await fireEvent.click(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫'))

      expect(reactionsApiMock.index).toBeCalled()
      expect(reactionsApiMock.index.mock.calls[0][0].lt).toBeTruthy()
      expect(dayjs(reactionsApiMock.index.mock.calls[0][0].lt).isSame(lastReaction.createdAt)).toBeTruthy()
    })

    test('Ë™≠Ëæº‰∏≠„ÅØdisabled, indeterminate', async () => {
      const { getByTitle } = render(AppFormReaction, options)

      expect(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).not.toHaveAttribute('disabled')
      expect(within(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).queryByRole('status')).not.toBeInTheDocument()

      reactionsApiMock.indexing.value = true

      await waitFor(() => {
        expect(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).toHaveAttribute('disabled')
        expect(within(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫')).getByRole('status')).toBeInTheDocument()
      })
    })

    test('Ë™≠„ÅøËæº„Åæ„Çå„Åü„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÖàÈ†≠„Å´ËøΩÂä†Ë°®Á§∫', async () => {
      reactionsApiMock.reactions.value = reactionFactory.buildList(1, { emoji: 'üç£' })

      const { getByTitle, container } = render(AppFormReaction, options)
      await fireEvent.click(getByTitle('Âè§„ÅÑ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫'))

      await waitFor(() => {
        expect(container.querySelectorAll('img.emoji')).toHaveLength(101)
        expect(container.querySelectorAll('img.emoji')[0]).toHaveAttribute('alt', 'üç£')
      })
    })
  })

  describe('„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†', () => {
    let twemojiPickerEmitsList: ReturnType<typeof useMockedComponent>['emitsList']

    beforeEach(() => {
      const { component, emitsList } = useMockedComponent({ emits: ['select'] })
      options.stubs.AppTwemojiPicker = component
      twemojiPickerEmitsList = emitsList
    })

    test('ÁµµÊñáÂ≠ó„ÅåÈÅ∏Êäû„Åï„Çå„Åü„ÇâÁôªÈå≤Âá¶ÁêÜ„ÇíÂÆüË°å', () => {
      render(AppFormReaction, options)
      twemojiPickerEmitsList[0].select('üç£')

      expect(reactionsApiMock.create).toBeCalledWith({ emoji: 'üç£' })
    })

    test('ÁôªÈå≤‰∏≠„ÅØdisabled, indeterminate', async () => {
      const { getByTitle } = render(AppFormReaction, options)
      reactionsApiMock.creating.value = true

      await waitFor(() => {
        expect(getByTitle('„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†')).toHaveAttribute('disabled')
        within(getByTitle('„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†')).getByRole('status')
      })
    })

    test('Âá¶ÁêÜÁµÇ‰∫ÜÂæå„ÅØadded„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´', async () => {
      const { emitted } = render(AppFormReaction, options)
      twemojiPickerEmitsList[0].select('üç£')

      await waitFor(() => {
        expect(emitted().added).toHaveLength(1)
        expect(emitted().added[0][0]).toBeInstanceOf(Post)
      })
    })

    test('Âá¶ÁêÜÁµÇ‰∫ÜÂæå„ÅØ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÖàÈ†≠„Å´ËøΩÂä†', async () => {
      reactionsApiMock.reaction.value = reactionFactory.build({ emoji: 'üç£' })
      const { emitted } = render(AppFormReaction, options)
      twemojiPickerEmitsList[0].select('üç£')

      await waitFor(() => {
        expect(emitted().added[0][0].reactions).toHaveLength(1)
        expect(emitted().added[0][0].reactions[0].emoji).toBe('üç£')
        expect(emitted().added[0][0].reactionsCount).toBe(1)
      })
    })
  })

  describe('delete', () => {
    beforeEach(() => {
      options.props.post.reactions = reactionFactory.buildList(1, { emoji: 'üç£' })
      store.store.session.setUser(userFactory.build())
    })

    test('„É≠„Ç∞„Ç§„É≥‰∏≠„Å´„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫', async () => {
      const { getByAltText, getByText } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))

      expect(getByText('„Åì„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')).toBeInTheDocument()
    })

    test('„É≠„Ç∞„Ç§„É≥‰∏≠„Åß„Å™„Åë„Çå„Å∞„É¢„Éº„ÉÄ„É´„ÅØÂá∫„Å™„ÅÑ', async () => {
      store.store.session.setUser(null)
      const { getByAltText, queryByText } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))

      expect(queryByText('„Åì„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')).not.toBeInTheDocument()
    })

    test('„É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„Ç≠„É£„É≥„Çª„É´„ÇíÊäº„Åô„Å®„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã', async () => {
      const { getByAltText, getByRole, queryByText } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))
      await fireEvent.click(getByRole('button', { name: '„Ç≠„É£„É≥„Çª„É´' }))

      expect(queryByText('„Åì„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')).not.toBeInTheDocument()
    })

    test('„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅßÂâäÈô§„Åô„Çã„ÇíÊäº„Åô„Å®ÂâäÈô§Âá¶ÁêÜ„ÇíÂÆüË°å', async () => {
      const { getByAltText, getByRole } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))
      await fireEvent.click(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' }))

      expect(reactionsApiMock.destroy).toBeCalled()
      expect(reactionsApiMock.reaction.value).toBe(options.props.post.reactions[0])
    })

    test('ÂâäÈô§‰∏≠„ÅØ„É¢„Éº„ÉÄ„É´ÂÜÖ„Éú„Çø„É≥„ÇíÊäº„Åõ„Å™„ÅÑ', async () => {
      const { getByAltText, getByRole } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))

      expect(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' })).not.toHaveAttribute('disabled')
      expect(getByRole('button', { name: '„Ç≠„É£„É≥„Çª„É´' })).not.toHaveAttribute('disabled')

      reactionsApiMock.destroying.value = true

      await waitFor(() => {
        expect(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' })).toHaveAttribute('disabled')
        expect(getByRole('button', { name: '„Ç≠„É£„É≥„Çª„É´' })).toHaveAttribute('disabled')
      })
    })

    test('ÂâäÈô§‰∏≠„ÅØ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çâ„Çå„Å™„ÅÑ', async () => {
      const { getByAltText, queryByLabelText, getByRole } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))

      expect(queryByLabelText('close')).toBeInTheDocument()
      expect(getByRole('button', { name: '„Ç≠„É£„É≥„Çª„É´' })).not.toHaveAttribute('disabled')

      reactionsApiMock.destroying.value = true

      await waitFor(() => {
        expect(queryByLabelText('close')).not.toBeInTheDocument()
      })
    })

    test('Âá¶ÁêÜÁµÇ‰∫ÜÂæå„ÅØdeleted„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´', async () => {
      const { getByAltText, getByRole, emitted } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))
      await fireEvent.click(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' }))

      await waitFor(() => {
        expect(emitted().deleted).toHaveLength(1)
        expect(emitted().deleted[0][0]).toBeInstanceOf(Post)
      })
    })

    test('Âá¶ÁêÜÁµÇ‰∫ÜÂæå„ÅØ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§', async () => {
      const { getByAltText, getByRole, emitted } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))
      await fireEvent.click(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' }))

      await waitFor(() => {
        expect(emitted().deleted[0][0].reactions).toHaveLength(0)
      })
    })

    test('Âá¶ÁêÜÁµÇ‰∫ÜÂæå„ÅØ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã', async () => {
      const { getByAltText, getByRole, queryByText } = render(AppFormReaction, options)

      await fireEvent.click(getByAltText('üç£'))
      await fireEvent.click(getByRole('button', { name: 'ÂâäÈô§„Åô„Çã' }))

      await waitFor(() => {
        expect(queryByText('„Åì„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')).not.toBeInTheDocument()
      })
    })
  })
})
